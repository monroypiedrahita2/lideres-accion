<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-in-up">
  <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <mg-title title="Control y accesos"></mg-title>
      <p class="mt-2 text-gray-600 text-sm text-center">Administre los roles y permisos de los usuarios del sistema.</p>
    </div>
  </div>

  <!-- Search Section -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 transition-shadow hover:shadow-md">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Search Form -->
      <div class="w-full lg:w-1/3">
        <form [formGroup]="form" class="flex flex-col gap-4">
          <div class="relative flex justify-center items-center">
            <mg-input-text class="w-full" type="text" formControlName="usuario" id="user"
              label="Correo electrónico"></mg-input-text>
            <button *ngIf="form.get('usuario')?.value" type="button" (click)="clear()"
              class="absolute right-2 text-gray-400 hover:text-gray-600">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <div class="flex justify-center items-center gap-3">
            <mg-button [text]="'Buscar Usuario'" [loading]="loading" [disabled]="form.invalid" (onClick)="getPerfil()"
              icon="search"></mg-button>
          </div>
        </form>
      </div>

      <!-- Selected User Preview (Right side) -->
      <div class="w-full lg:w-2/3 border-l border-gray-100 pl-0 lg:pl-8">
        <div *ngIf="!perfilSeleted" class="h-full flex flex-col items-center justify-center text-gray-400 py-8 lg:py-0">
          <mat-icon class="!w-12 !h-12 !text-[48px] mb-3 opacity-20">person_search</mat-icon>
          <p class="text-sm text-center">Busque un usuario por correo electrónico para gestionar su rol</p>
        </div>

        <div *ngIf="perfilSeleted" class="animate-fade-in">
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 sm:p-6 border border-blue-100">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
              <!-- User Info -->
              <div class="flex flex-col sm:flex-row items-center gap-4 w-full">
                <div class="text-center sm:text-left w-full min-w-0">
                  <h3 class="text-xl font-bold text-gray-900 tracking-tight break-words text-center">{{
                    perfilSeleted.nombres }} {{ perfilSeleted.apellidos }}</h3>
                  <div class="flex flex-col gap-2 mt-2 w-full">
                    <!-- Mobile View (Vertical Stack) -->
                    <div class="flex flex-col gap-2 sm:hidden text-sm text-gray-500 w-full mt-2">
                      <div class="flex items-start gap-3 w-full">
                        <mat-icon class="!w-5 !h-5 !text-[20px] shrink-0 text-gray-400 mt-0.5">email</mat-icon>
                        <span class="break-words text-left">{{ perfilSeleted.email }}</span>
                      </div>

                      <div class="flex items-center gap-3 w-full">
                        <mat-icon class="!w-5 !h-5 !text-[20px] shrink-0 text-gray-400">phone</mat-icon>
                        <span>{{ perfilSeleted.celular || 'No registrado' }}</span>
                      </div>
                    </div>

                    <!-- Desktop View (Horizontal Row) -->
                    <div class="hidden sm:flex flex-col items-center gap-4 text-sm text-gray-500">
                      <span class="flex items-center gap-2" title="{{ perfilSeleted.email }}">
                        <mat-icon class="!w-4 !h-4 !text-[16px] shrink-0">email</mat-icon>
                        <span class="truncate max-w-[200px]">{{ perfilSeleted.email }}</span>
                      </span>

                      <span class="flex items-center gap-2">
                        <mat-icon class="!w-4 !h-4 !text-[16px] shrink-0">phone</mat-icon> {{ perfilSeleted.celular ||
                        'No registrado' }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex flex-col items-center justify-center gap-2 w-full md:w-auto md:min-w-[140px] shrink-0">
                <div class="flex justify-center items-center w-full">
                  <mg-button [text]="'Gestionar Rol'" (onClick)="gestionarRol()" icon="verified_user"></mg-button>
                </div>
                <button (click)="clear()"
                  class="text-xs text-gray-500 hover:text-gray-700 underline text-center py-1 cursor-pointer">
                  Limpiar búsqueda
                </button>
              </div>
            </div>

            <div
              class="mt-6 pt-4 border-t border-blue-100/50 flex flex-col items-center justify-center sm:justify-start gap-2 text-center sm:text-left">
              <span class="text-sm font-medium text-gray-600">Rol asignado:</span>
              <span class="px-3 py-1 rounded-full text-sm font-semibold border"
                [ngClass]="perfilSeleted.rol ? 'bg-white text-blue-700 border-blue-200' : 'bg-gray-100 text-gray-500 border-gray-200'">
                {{ perfilSeleted.rol || 'Sin rol asignado' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="border-t border-gray-200 my-8"></div>

  <!-- Users List Section -->
  <div>
    <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center gap-2">
      <mat-icon>group</mat-icon>
      Usuarios con roles activos
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      <lida-person-card *ngFor="let user of usuarios" [person]="user"
        [showDeleteAction]="user.rol !== 'Sin rol asignado'" [showEditAction]="true"
        (deleteClicked)="deleteRol(user.id!)" (editClicked)="gestionarRol(user)"></lida-person-card>
    </div>

    <div *ngIf="usuarios.length === 0"
      class="text-center py-12 bg-gray-50 rounded-xl border border-dashed border-gray-300">
      <p class="text-gray-500">No hay usuarios con roles asignados en este momento.</p>
    </div>
  </div>
</div>