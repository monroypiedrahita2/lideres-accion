<div class="p-1" *ngIf="usuario?.postulado">
    <div class="grid gap-4 sm:grid-cols-1 md:grid-cols-2">
        <!-- Vehiculo Status -->
        <div *ngIf="usuario?.postulado?.transporte" class="p-4 rounded-lg bg-gray-50 border-l-4"
            [ngClass]="getBorderColor(vehiculoStatus)">
            <div class="flex justify-between items-center mb-2">
                <span class="font-semibold text-lg text-black">Información del conductor</span>
                <mat-icon [class]="getTextColor(vehiculoStatus)">directions_car</mat-icon>
            </div>
            <p class="text-lg font-semibold" [class]="getTextColor(vehiculoStatus)">
                {{ vehiculoStatus || 'Cargando...' }}
            </p>
            <div *ngIf="vehiculoInfo" class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-600 flex flex-col">
                <span class="text-lg text-black"><strong>Asociado a:</strong> {{ vehiculoInfo.casaApoyo }}</span>
                <span class="text-lg text-black"><strong>Dirección:</strong> {{ vehiculoInfo.direccion }}</span>
                <span class="text-lg text-black"><strong>Barrio:</strong> {{ vehiculoInfo.barrio }}</span>

                <div class="flex gap-2 mt-2 w-full justify-between" *ngIf="vehiculoInfo.responsableTelefono">
                    <mg-icon-whatsapp [phone]="vehiculoInfo.responsableTelefono" size="small"></mg-icon-whatsapp>
                    <mg-icon-button icon="call" [link]="'tel:' + vehiculoInfo.responsableTelefono" variant="info"
                        size="small"></mg-icon-button>
                </div>

                <!-- Status Selector -->
                <div *ngIf="vehiculoStatus === 'Aprobado' && currentVehiculo"
                    class="mt-4 pt-2 border-t border-gray-100">
                    <p class="text-lg font-semibold text-black mb-2">Estado del vehículo:</p>
                    <div class="flex flex-wrap justify-between gap-2">
                        <button (click)="updateVehiculoStatus('Activo')"
                            [class]="currentVehiculo.estado === 'Activo' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                            class="px-3 py-1 rounded-full text-lg font-medium transition-colors">
                            Activo
                        </button>
                        <button (click)="updateVehiculoStatus('Inactivo')"
                            [class]="currentVehiculo.estado === 'Inactivo' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                            class="px-3 py-1 rounded-full text-lg font-medium transition-colors">
                            Inactivo
                        </button>
                        <button (click)="updateVehiculoStatus('En carrera')"
                            [class]="currentVehiculo.estado === 'En carrera' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                            class="px-3 py-1 rounded-full text-lg font-medium transition-colors">
                            En carrera
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Casa Apoyo Status -->
        <div *ngIf="usuario?.postulado?.casaApoyo" class="p-4 rounded-lg bg-gray-50 border-l-4"
            [ngClass]="getBorderColor(casaApoyoStatus)">
            <div class="flex justify-between items-center mb-2">
                <span class="font-semibold text-lg text-black">Casa de apoyo</span>
                <mat-icon [class]="getTextColor(casaApoyoStatus)">home</mat-icon>
            </div>
            <p class="text-lg font-semibold" [class]="getTextColor(casaApoyoStatus)">
                {{ casaApoyoStatus || 'Cargando...' }}
            </p>

            <!-- Vehicles Accordion -->
            <mat-accordion *ngIf="casaApoyoStatus === 'Aprobado' && casaApoyoVehiculos.length > 0"
                class="mt-4 block w-full">
                <mat-expansion-panel class="!shadow-none !bg-transparent border border-gray-200">
                    <mat-expansion-panel-header class="!h-10">
                        <mat-panel-title class="!text-sm text-gray-600">
                            Vehículos Asociados ({{casaApoyoVehiculos.length}})
                        </mat-panel-title>
                    </mat-expansion-panel-header>

                    <div class="flex flex-col gap-2 mt-2">
                        <div *ngFor="let vehiculo of casaApoyoVehiculos"
                            class="flex flex-col bg-white p-2 rounded border border-gray-300 shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-md font-bold text-black">{{ vehiculo.tipoVehiculo }} - {{
                                        vehiculo.placa }}</p>
                                    <p class="text-lg text-black">{{ vehiculo.nombre }} {{ vehiculo.apellidos }}</p>
                                    <div class="mt-1">
                                        <span
                                            [class]="getStatusColor(vehiculo.estado || 'Inactivo') + ' px-2 py-0.5 rounded-full text-lg font-medium border border-opacity-20'">
                                            {{ vehiculo.estado || 'Inactivo' }}
                                        </span>
                                        <span *ngIf="calculateDistance(vehiculo)" class="ml-2 text-sm text-gray-500">
                                            A {{ calculateDistance(vehiculo) }}
                                        </span>
                                        <span
                                            *ngIf="!calculateDistance(vehiculo) && (vehiculo.estado === 'Activo' || vehiculo.estado === 'En carrera') && !vehiculo.ubicacionActual"
                                            class="ml-2 text-xs text-red-400">
                                            Sin ubicación
                                        </span>
                                        <span
                                            *ngIf="!calculateDistance(vehiculo) && (vehiculo.estado === 'Activo' || vehiculo.estado === 'En carrera') && vehiculo.ubicacionActual && !userLocation"
                                            class="ml-2 text-xs text-orange-400">
                                            Calculando...
                                        </span>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <mg-icon-whatsapp *ngIf="vehiculo.celular" [phone]="vehiculo.celular"
                                        size="small"></mg-icon-whatsapp>
                                    <mg-icon-button *ngIf="vehiculo.celular" icon="call"
                                        [link]="'tel:' + vehiculo.celular" variant="primary"
                                        size="small"></mg-icon-button>
                                    <mg-icon-button *ngIf="vehiculo.ubicacionActual" icon="location_on"
                                        [link]="'https://www.google.com/maps/search/?api=1&query=' + vehiculo.ubicacionActual.lat + ',' + vehiculo.ubicacionActual.lng"
                                        variant="danger" size="small" target="_blank">
                                    </mg-icon-button>
                                </div>
                            </div>
                            <button (click)="openModalAsignarCarrera(vehiculo)" *ngIf="vehiculo.estado === 'Activo'"
                                class="mt-1 rounded-full relative inline-flex items-center justify-center overflow-hidden text-sm font-medium text-heading group bg-gradient-to-br from-purple-600 to-blue-500 group-hover:from-purple-600 hover:text-white dark:text-white focus:ring-4 focus:outline-none">
                                <span
                                    class=" relative px-4 py-0.5 transition-all ease-in duration-75 bg-neutral-primary-soft rounded-full group-hover:bg-transparent group-hover:dark:bg-transparent leading-5">
                                    Asignar carrera
                                </span>
                            </button>
                        </div>
                    </div>

                </mat-expansion-panel>
            </mat-accordion>
        </div>

        <!-- Coordinador de Testigo Status -->
        <div *ngIf="usuario?.postulado?.testigo" class="p-4 rounded-lg bg-gray-50 border-l-4"
            [ngClass]="getBorderColor(testigoStatus)">
            <div class="flex justify-between items-center mb-2">
                <span class="font-semibold text-lg text-black">Coordinador puesto de votación</span>
                <mat-icon [class]="getTextColor(testigoStatus)">how_to_vote</mat-icon>
            </div>
            <p class="text-lg font-semibold" [class]="getTextColor(testigoStatus)">
                {{ testigoStatus || 'Cargando...' }}
            </p>
            <div *ngIf="testigoInfo" class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-600 flex flex-col">
                <span class="text-lg text-black"><strong>Puesto:</strong> {{ testigoInfo.puesto }}</span>
                <span class="text-lg text-black"><strong>Mesa:</strong> {{ testigoInfo.mesa }}</span>
            </div>

            <!-- Witnesses List -->
            <mat-accordion *ngIf="misTestigos.length > 0" class="mt-4 block w-full">
                <mat-expansion-panel class="!shadow-none !bg-transparent border border-gray-200">
                    <mat-expansion-panel-header class="!h-10">
                        <mat-panel-title class="!text-sm text-gray-600">
                            Testigos Asociados ({{misTestigos.length}})
                        </mat-panel-title>
                    </mat-expansion-panel-header>

                    <div class="flex flex-col gap-2 mt-2">
                        <div *ngFor="let testigo of misTestigos"
                            class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div>
                                <p class="font-medium text-sm text-gray-900">{{ testigo.data.nombre }} {{
                                    testigo.data.apellido }}
                                </p>
                                <p class="text-xs text-gray-500">Mesa: {{ testigo.data.mesa }}</p>
                            </div>
                            <div class="flex gap-2">
                                <mg-icon-whatsapp *ngIf="testigo.data.celular" [phone]="testigo.data.celular"
                                    size="small"></mg-icon-whatsapp>
                                <mg-icon-button *ngIf="testigo.data.celular" icon="call"
                                    [link]="'tel:' + testigo.data.celular" variant="primary"
                                    size="small"></mg-icon-button>
                            </div>
                        </div>
                    </div>

                </mat-expansion-panel>
            </mat-accordion>

            <!-- Actions -->
            <div *ngIf="testigoInfo" class="flex justify-end gap-3 mt-4 pt-2 border-t border-gray-100">
                <mg-icon-whatsapp phone="" size="small"></mg-icon-whatsapp>
                <mg-button text="Resultados" size="small" icon="send" (onClick)="onNavigateResults()"></mg-button>
            </div>
        </div>
    </div>
</div>